webpackJsonpCoveo__temporary([76],{235:function(t,o,e){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var e in o)o.hasOwnProperty(e)&&(t[e]=o[e])};return function(o,e){function n(){this.constructor=o}t(o,e),o.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();Object.defineProperty(o,"__esModule",{value:!0});var i=e(7),r=e(8),a=e(5),s=e(11),c=e(17),u=e(53),p=e(93),h=e(1),d=e(2),l=e(6),f=e(26),m=e(0),v=e(3);e(596);var g=e(12);o.authProviderAccessToken="coveo-auth-provider-access-token";var y=function(t){function e(o,n,i,p){void 0===n&&(n={});var h=t.call(this,o,e.ID,i)||this;return h.element=o,h.options=n,h._window=p,h.options=r.ComponentOptions.initComponentOptions(o,e,n),a.Assert.exists(h.options.name),h.handlers=[],h._window=h._window||window,h.redirectCount=0,h.bind.onRootElement(s.QueryEvents.buildingCallOptions,h.handleBuildingCallOptions),h.bind.onRootElement(s.QueryEvents.queryError,h.handleQueryError),h.bind.onRootElement(c.InitializationEvents.nuke,h.handleNuke),h.bind.onRootElement(c.InitializationEvents.afterComponentsInitialization,function(t){return h.onAfterComponentsInitialization(t)}),h.bind.onRootElement(u.SettingsEvents.settingsPopulateMenu,function(t){t.menuData.push({text:l.l("Reauthenticate",h.options.caption),className:"coveo-authentication-provider",onOpen:function(){return h.authenticateWithProvider()},svgIcon:g.SVGIcons.icons.dropdownAuthenticate,svgIconClassName:"coveo-authentication-provider-svg"})}),h}return n(e,t),e.prototype.getHandshakeTokenFromUrl=function(){var t=window.location.hash.slice(1),o=t.split("&"),e=m.find(o,function(t){return"handshake_token"===t.split("=")[0]});if(!e)return"";var n=e.split("=")[1];return n?decodeURIComponent(n):""},e.prototype.onAfterComponentsInitialization=function(t){var o=this,e=this.getHandshakeTokenFromUrl();if(!e)return this.loadAccessTokenFromStorage();var n=this.exchangeHandshakeToken(e).then(function(t){return o.storeAccessToken(t)}).then(function(){return o.loadAccessTokenFromStorage()}).catch(function(t){return o.logger.error(t)});t.defer.push(n)},e.prototype.exchangeHandshakeToken=function(t){return this.queryController.getEndpoint().exchangeAuthenticationProviderToken(t)},e.prototype.storeAccessToken=function(t){localStorage.setItem(o.authProviderAccessToken,t)},e.prototype.loadAccessTokenFromStorage=function(){var t=localStorage.getItem(o.authProviderAccessToken);t&&this.queryController.getEndpoint().accessToken.updateToken(t)},e.prototype.handleBuildingCallOptions=function(t){t.options.authentication.push(this.options.name)},e.prototype.handleQueryError=function(t){var o=t.error;o.isMissingAuthentication&&o.provider===this.options.name&&this.redirectCount<2&&-1!==this.redirectCount?(++this.redirectCount,this.authenticateWithProvider()):(this.logger.error("The AuthenticationProvider is in a redirect loop. This may be due to a back-end configuration problem."),this.redirectCount=-1)},e.prototype.authenticateWithProvider=function(){this.options.useIFrame?this.authenticateWithIFrame():this.redirectToAuthenticationProvider()},e.prototype.redirectToAuthenticationProvider=function(){this.logger.info("Redirecting to authentication provider "+this.options.name),this._window.location.href=this.getAuthenticationProviderUriForRedirect()},e.prototype.authenticateWithIFrame=function(){this.logger.info("Using iframe to retrieve authentication for provider "+this.options.name);var t,o=h.$$("iframe",{src:this.getAuthenticationProviderUriForIFrame()}).el;t=this.options.showIFrame?this.createPopupForVisibleIFrame(o):this.createPopupForWaitMessage(o);var e=this.createHandler(t,o);h.$$(this._window).one("message",e),this.handlers.push(e)},e.prototype.createHandler=function(t,o){var e=this;return function(){h.$$(o).detach(),e.logger.info("Got authentication for provider "+e.options.name+"; retrying query."),t.close(),e.queryController.executeQuery()}},e.prototype.handleNuke=function(){var t=this;m.each(this.handlers,function(o){return h.$$(t._window).off("message",o)})},e.prototype.createPopupForWaitMessage=function(t){var o=h.$$("div",{className:"coveo-waiting-for-authentication-popup"},p.DomUtils.getBasicLoadingAnimation()).el;return h.$$(t).hide(),document.body.appendChild(t),f.ModalBox.open(o,{title:l.l("Authenticating",this.options.caption),sizeMod:"small",body:this.searchInterface.options.modalContainer}),f.ModalBox},e.prototype.createPopupForVisibleIFrame=function(t){h.$$(t).addClass("coveo-authentication-iframe");var o=h.$$("div",{},t).el;return f.ModalBox.open(o,{title:l.l("Authenticating",this.options.caption),className:"coveo-authentication-popup",sizeMod:"big",body:this.searchInterface.options.modalContainer}),f.ModalBox},e.prototype.getAuthenticationProviderUriForRedirect=function(){return this.queryController.getEndpoint().getAuthenticationProviderUri(this.options.name,this._window.location.href,void 0)},e.prototype.getAuthenticationProviderUriForIFrame=function(){return this.queryController.getEndpoint().getAuthenticationProviderUri(this.options.name,void 0,"success")},e.ID="AuthenticationProvider",e.doExport=function(){v.exportGlobally({AuthenticationProvider:e})},e.options={name:r.ComponentOptions.buildStringOption(),caption:r.ComponentOptions.buildStringOption({postProcessing:function(t,o){return t||o.name}}),useIFrame:r.ComponentOptions.buildBooleanOption({defaultValue:!1,alias:["useIframe"]}),showIFrame:r.ComponentOptions.buildBooleanOption({defaultValue:!0,alias:["showIframe"],depend:"useIFrame"})},e}(i.Component);o.AuthenticationProvider=y,d.Initialization.registerAutoCreateComponent(y)},596:function(t,o){}});
//# sourceMappingURL=AuthenticationProvider.min__e1307ab4e6b70217a382.js.map