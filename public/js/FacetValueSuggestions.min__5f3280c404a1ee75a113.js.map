{"version":3,"sources":["FacetValueSuggestions.min__5f3280c404a1ee75a113.js","./src/ui/FacetValueSuggestions/FacetValueSuggestions.ts","./src/ui/FacetValueSuggestions/FacetValueSuggestionsProvider.ts"],"names":["webpackJsonpCoveo__temporary","252","module","exports","__webpack_require__","__extends","this","extendStatics","Object","setPrototypeOf","__proto__","Array","d","b","p","hasOwnProperty","__","constructor","prototype","create","__assign","assign","t","s","i","n","arguments","length","call","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","__generator","body","verb","v","op","f","TypeError","_","y","label","ops","pop","trys","push","g","sent","throw","return","Symbol","iterator","defineProperty","element","options","bindings","FacetValueSuggestions","ID","ComponentOptions","initComponentOptions","facetValueSuggestionsProvider","FacetValueSuggestionsProvider","queryController","field","expression","queryStateFieldFacetId","templateHelper","defaultTemplate","$$","root","on","OmniboxEvents","populateOmniboxSuggestions","args","suggestions","getSuggestions","omnibox","_this","row","keyword","html","facetValue","DomUtils","highlight","details","displayEstimateNumberOfResults","l","numberOfResults","toString","getQuerySuggestionKeywordFromText","text","_a","numberOfSuggestions","getText","getFacetValueSuggestions","getQuerySuggestionsKeywords","useQuerySuggestions","suggestionAddon","getSuggestion","map","wordsToQuery","suggestionsKeywords","allKeywordsToQuery","useValueFromSearchbox","unique","concat","filter","getSuggestionsForWords","keywordToQuery","currentSelectedValues_1","filteredSuggestions","error_1","logger","debug","queryStateModel","get","suggestion","isSuggestionRowAlreadyCheckedInFacet","rankSuggestionRows","mapFacetValueSuggestion","error","currentlySelectedValues","some","rankedResults","sort","a","score","distanceFromTotalForField","firstSlice","Math","ceil","lastSlice","floor","firstResultsToReturn","splice","lastResultsToReturn","slice","resultToShow","buildDisplayNameForRow","fieldValues","isCategoryField","split","categoryFieldDelimitingCharacter","advancedQuery","join","onSelect","onSuggestionSelected","ex","setText","fvState","QueryStateModel","attributesEnum","fv","existingValues","set","magicBox","blur","usageAnalytics","logSearchEvent","analyticsActionCauseList","omniboxField","executeQuery","doExport","exportGlobally","buildFieldOption","required","buildNumberOption","defaultValue","min","buildBooleanOption","postProcessing","buildCustomOption","buildStringOption","depend","buildQueryExpressionOption","Component","Initialization","registerAutoCreateComponent","516","613","valuesToSearch","fieldsToQuery","getFieldValuesToQuery","getAllSuggestionsRows","responses","reference","fieldResponses","fieldTotalReference","reduce","allValues","fieldResponse","suggestionRows","values","indexFieldValue","computeScoreForSuggestionRow","referenceValuesRequest","queryParts","suggestionValuesRequests","requests","buildReferenceFieldValueRequest","getQueryToExecuteParts","queryToExecute","buildListFieldValueRequest","getEndpoint","listFieldValuesBatch","batch","computeReferenceFromBatch","fieldValue","totalNumberForFieldValue","fieldsTotal","smallestTotal","forEach","ignoreAccents","maximumNumberOfValues","queryOverride","lastQuery","getLastQuery","aq","removeFieldExpressionFromExpression","cq","part","replace","RegExp"],"mappings":"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","file":"FacetValueSuggestions.min__5f3280c404a1ee75a113.js","sourcesContent":["webpackJsonpCoveo__temporary([45],{\n\n/***/ 252:\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nvar __assign = (this && this.__assign) || Object.assign || function(t) {\r\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n        s = arguments[i];\r\n        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\r\n            t[p] = s[p];\r\n    }\r\n    return t;\r\n};\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = y[op[0] & 2 ? \"return\" : op[0] ? \"throw\" : \"next\"]) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [0, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\n__webpack_require__(516);\r\nvar _ = __webpack_require__(0);\r\nvar OmniboxEvents_1 = __webpack_require__(33);\r\nvar GlobalExports_1 = __webpack_require__(3);\r\nvar MiscModules_1 = __webpack_require__(71);\r\nvar ModelsModules_1 = __webpack_require__(201);\r\nvar Dom_1 = __webpack_require__(1);\r\nvar UtilsModules_1 = __webpack_require__(121);\r\nvar AnalyticsActionListMeta_1 = __webpack_require__(10);\r\nvar Component_1 = __webpack_require__(7);\r\nvar ComponentOptions_1 = __webpack_require__(8);\r\nvar Initialization_1 = __webpack_require__(2);\r\nvar FacetValueSuggestionsProvider_1 = __webpack_require__(613);\r\n/**\r\n * This component provides [`Omnibox`]{@link Omnibox} query suggestions scoped to distinct categories based on the values of a\r\n * specific [`field`]{@link FacetValueSuggestions.options.field} whose [Facet](https://docs.coveo.com/en/1982/#facet) option is enabled.\r\n *\r\n * @externaldocs [Providing Facet Value Suggestions](https://docs.coveo.com/en/340/#providing-facet-value-suggestions)\r\n *\r\n * @availablesince [May 2018 Release (v2.4094.8)](https://docs.coveo.com/410/#may-2018-release-v240948)\r\n */\r\nvar FacetValueSuggestions = /** @class */ (function (_super) {\r\n    __extends(FacetValueSuggestions, _super);\r\n    /**\r\n     * Creates a new `FacetValueSuggestions` component.\r\n     * @param element The HTMLElement on which to instantiate the component.\r\n     * @param options The options for the `FacetValueSuggestions` component.\r\n     * @param bindings The bindings that the component requires to function normally. If not set, these will be\r\n     * automatically resolved (with a slower execution time).\r\n     */\r\n    function FacetValueSuggestions(element, options, bindings) {\r\n        var _this = _super.call(this, element, FacetValueSuggestions.ID, bindings) || this;\r\n        _this.options = options;\r\n        _this.options = ComponentOptions_1.ComponentOptions.initComponentOptions(element, FacetValueSuggestions, options);\r\n        _this.facetValueSuggestionsProvider = new FacetValueSuggestionsProvider_1.FacetValueSuggestionsProvider(_this.queryController, {\r\n            field: _this.options.field,\r\n            expression: _this.options.expression\r\n        });\r\n        _this.queryStateFieldFacetId = \"f:\" + _this.options.field;\r\n        if (!_this.options.templateHelper) {\r\n            _this.options.templateHelper = FacetValueSuggestions.defaultTemplate;\r\n        }\r\n        Dom_1.$$(_this.root).on(OmniboxEvents_1.OmniboxEvents.populateOmniboxSuggestions, function (e, args) {\r\n            args.suggestions.push(_this.getSuggestions(args.omnibox));\r\n        });\r\n        return _this;\r\n    }\r\n    FacetValueSuggestions.defaultTemplate = function (row, omnibox) {\r\n        var keyword = row.keyword.html;\r\n        var facetValue = UtilsModules_1.DomUtils.highlight(row.value, 'coveo-omnibox-hightlight');\r\n        var details = this.options.displayEstimateNumberOfResults\r\n            ? UtilsModules_1.DomUtils.highlight(\" (\" + MiscModules_1.l('ResultCount', row.numberOfResults.toString(), row.numberOfResults) + \")\", 'coveo-omnibox-suggestion-results-count', true)\r\n            : '';\r\n        return \"\" + MiscModules_1.l('KeywordInCategory', keyword, facetValue) + details;\r\n    };\r\n    FacetValueSuggestions.getQuerySuggestionKeywordFromText = function (text) {\r\n        return {\r\n            text: text,\r\n            html: UtilsModules_1.DomUtils.highlight(text, 'coveo-omnibox-hightlight')\r\n        };\r\n    };\r\n    FacetValueSuggestions.prototype.getSuggestions = function (omnibox) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var text, suggestions;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (this.options.numberOfSuggestions == 0) {\r\n                            return [2 /*return*/, []];\r\n                        }\r\n                        text = omnibox.getText();\r\n                        return [4 /*yield*/, this.getFacetValueSuggestions(text, omnibox)];\r\n                    case 1:\r\n                        suggestions = _a.sent();\r\n                        return [2 /*return*/, suggestions || []];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FacetValueSuggestions.prototype.getQuerySuggestionsKeywords = function (omnibox) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var suggestions;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(this.options.useQuerySuggestions && omnibox.suggestionAddon)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, omnibox.suggestionAddon.getSuggestion()];\r\n                    case 1:\r\n                        suggestions = _a.sent();\r\n                        return [2 /*return*/, suggestions.map(function (_a) {\r\n                                var text = _a.text, html = _a.html;\r\n                                return ({ text: text || '', html: html });\r\n                            })];\r\n                    case 2: return [2 /*return*/, []];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FacetValueSuggestions.prototype.getFacetValueSuggestions = function (text, omnibox) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var wordsToQuery, suggestionsKeywords, allKeywordsToQuery;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        wordsToQuery = this.options.useValueFromSearchbox ? [FacetValueSuggestions.getQuerySuggestionKeywordFromText(text)] : [];\r\n                        return [4 /*yield*/, this.getQuerySuggestionsKeywords(omnibox)];\r\n                    case 1:\r\n                        suggestionsKeywords = _a.sent();\r\n                        allKeywordsToQuery = _.unique(wordsToQuery.concat(suggestionsKeywords).filter(function (keyword) { return keyword.text != ''; }), function (keyword) { return keyword.text; });\r\n                        if (allKeywordsToQuery.length === 0) {\r\n                            return [2 /*return*/, []];\r\n                        }\r\n                        return [2 /*return*/, this.getSuggestionsForWords(allKeywordsToQuery, omnibox)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FacetValueSuggestions.prototype.getSuggestionsForWords = function (keywordToQuery, omnibox) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            var suggestions, currentSelectedValues_1, filteredSuggestions, error_1;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 2, , 3]);\r\n                        return [4 /*yield*/, this.facetValueSuggestionsProvider.getSuggestions(keywordToQuery)];\r\n                    case 1:\r\n                        suggestions = _a.sent();\r\n                        this.logger.debug('FacetValue Suggestions Results', suggestions);\r\n                        currentSelectedValues_1 = this.queryStateModel.get(this.queryStateFieldFacetId) || [];\r\n                        filteredSuggestions = suggestions.filter(function (suggestion) {\r\n                            return _this.isSuggestionRowAlreadyCheckedInFacet(suggestion, currentSelectedValues_1);\r\n                        });\r\n                        return [2 /*return*/, this.rankSuggestionRows(filteredSuggestions).map(function (result) { return _this.mapFacetValueSuggestion(result, omnibox); })];\r\n                    case 2:\r\n                        error_1 = _a.sent();\r\n                        this.logger.error(error_1);\r\n                        return [2 /*return*/, []];\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FacetValueSuggestions.prototype.isSuggestionRowAlreadyCheckedInFacet = function (suggestion, currentlySelectedValues) {\r\n        return !currentlySelectedValues.some(function (value) { return value == suggestion.value; });\r\n    };\r\n    FacetValueSuggestions.prototype.rankSuggestionRows = function (suggestions) {\r\n        var rankedResults = suggestions.sort(function (a, b) { return b.score.distanceFromTotalForField - a.score.distanceFromTotalForField; }).slice();\r\n        var firstSlice = Math.ceil(this.options.numberOfSuggestions / 2);\r\n        var lastSlice = -Math.floor(this.options.numberOfSuggestions / 2);\r\n        var firstResultsToReturn = rankedResults.splice(0, firstSlice);\r\n        if (lastSlice != 0) {\r\n            var lastResultsToReturn = rankedResults.slice(lastSlice);\r\n            return firstResultsToReturn.concat(lastResultsToReturn);\r\n        }\r\n        return firstResultsToReturn;\r\n    };\r\n    FacetValueSuggestions.prototype.mapFacetValueSuggestion = function (resultToShow, omnibox) {\r\n        var _this = this;\r\n        var suggestion = {\r\n            html: this.buildDisplayNameForRow(resultToShow, omnibox),\r\n            text: resultToShow.keyword.text\r\n        };\r\n        var fieldValues = this.options.isCategoryField\r\n            ? resultToShow.value.split(this.options.categoryFieldDelimitingCharacter)\r\n            : [resultToShow.value];\r\n        suggestion.advancedQuery = fieldValues.map(function (value) { return _this.options.field + \"==\\\"\" + value + \"\\\"\"; }).join(' AND ');\r\n        suggestion.onSelect = function () { return _this.onSuggestionSelected(suggestion, fieldValues, omnibox); };\r\n        return suggestion;\r\n    };\r\n    FacetValueSuggestions.prototype.buildDisplayNameForRow = function (row, omnibox) {\r\n        try {\r\n            return this.options.templateHelper.call(this, row, omnibox);\r\n        }\r\n        catch (ex) {\r\n            this.logger.error('Could not apply template from options for the given row. Will use default template.', ex, row, omnibox);\r\n            return FacetValueSuggestions.defaultTemplate.call(this, row, omnibox);\r\n        }\r\n    };\r\n    FacetValueSuggestions.prototype.onSuggestionSelected = function (suggestion, fieldValues, omnibox) {\r\n        omnibox.setText(suggestion.text);\r\n        // Copy the state here, else it will directly modify queryStateModel.defaultAttributes.fv.\r\n        var fvState = __assign({}, this.queryStateModel.get(ModelsModules_1.QueryStateModel.attributesEnum.fv));\r\n        var existingValues = fvState[this.options.field.toString()] || [];\r\n        fvState[this.options.field.toString()] = existingValues.concat(fieldValues);\r\n        this.queryStateModel.set(ModelsModules_1.QueryStateModel.attributesEnum.fv, fvState);\r\n        omnibox.magicBox.blur();\r\n        this.usageAnalytics.logSearchEvent(AnalyticsActionListMeta_1.analyticsActionCauseList.omniboxField, {});\r\n        this.queryController.executeQuery();\r\n    };\r\n    FacetValueSuggestions.ID = 'FacetValueSuggestions';\r\n    FacetValueSuggestions.doExport = function () {\r\n        GlobalExports_1.exportGlobally({\r\n            FacetValueSuggestions: FacetValueSuggestions\r\n        });\r\n    };\r\n    /**\r\n     * @componentOptions\r\n     */\r\n    FacetValueSuggestions.options = {\r\n        /**\r\n         * The field on whose values the scoped query suggestions should be based.\r\n         *\r\n         * @examples @productcategory\r\n         */\r\n        field: ComponentOptions_1.ComponentOptions.buildFieldOption({ required: true }),\r\n        /**\r\n         * The maximum number of suggestions to render in the [`Omnibox`]{@link Omnibox}.\r\n         */\r\n        numberOfSuggestions: ComponentOptions_1.ComponentOptions.buildNumberOption({ defaultValue: 5, min: 1 }),\r\n        /**\r\n         * Whether to get scoped query suggestions from the current Coveo ML query suggestions.\r\n         *\r\n         * **Note:** If this options is set to `true` the [`enableQuerySuggestAddon`]{@link Omnibox.options.enableQuerySuggestAddon} option of the [`Omnibox`]{@link Omnibox.option.enableQuerySuggestAddon} component must be set to `true` as well.\r\n         */\r\n        useQuerySuggestions: ComponentOptions_1.ComponentOptions.buildBooleanOption({ defaultValue: true }),\r\n        /**\r\n         * Whether to get scoped query suggestions from the current user query entered in the search box.\r\n         *\r\n         * **Default:** `true` if [`useQuerySuggestions`]{@link FacetValueSuggestions.options.useQuerySuggestions} is `false`; `false` otherwise\r\n         */\r\n        useValueFromSearchbox: ComponentOptions_1.ComponentOptions.buildBooleanOption({\r\n            postProcessing: function (value, options) {\r\n                return value || !options.useQuerySuggestions;\r\n            }\r\n        }),\r\n        /**\r\n         * Whether to display an estimate of the number of results for each scoped query suggestions.\r\n         *\r\n         * **Notes:**\r\n         * - Setting this option to `true` has no effect when the [`templateHelper`]{@link FacetValueSuggestions.options.templateHelper} options is set.\r\n         * - When displaying scoped query suggestions for a standalone search box whose queries are redirected to a search interface enforcing other filters, the number of results will be inaccurate.\r\n         */\r\n        displayEstimateNumberOfResults: ComponentOptions_1.ComponentOptions.buildBooleanOption({ defaultValue: false }),\r\n        /**\r\n         * The template helper function to execute when rendering each scoped query suggestion.\r\n         *\r\n         * If specified, the function must have the following signature: (row: [IFacetValueSuggestionRow]{@link IFacetValueSuggestionRow}, omnibox: Omnibox) => string\r\n         *\r\n         * If not specified, a default function will be used.\r\n         *\r\n         * **Note:** You cannot set this option directly in the component markup as an HTML attribute. You must either set it:\r\n         * - In the [`init`]{@link init} call of your search interface (see [Passing Component Options in the init Call](https://docs.coveo.com/en/346/#passing-component-options-in-the-init-call)\r\n         * - Before the `init` call, using the [`options`](@link options) top-level function (see [Passing Component Options Before the init Call](https://docs.coveo.com/en/346/#passing-component-options-before-the-init-call)).\r\n         *\r\n         * **Example:**\r\n         *\r\n         * ```javascript\r\n         * Coveo.init(document.getElementById('search'), {\r\n         *   FacetValueSuggestions: {\r\n         *     templateHelper: (row, omnibox) => { return `Searching for <strong>${row.keyword}</strong> in category <em>${row.value}</em>`; }\r\n         *   }\r\n         * })\r\n         * ```\r\n         */\r\n        templateHelper: ComponentOptions_1.ComponentOptions.buildCustomOption(function () {\r\n            return null;\r\n        }),\r\n        /**\r\n         * Whether the [`field`]{@link FacetValueSuggestions.options.field} option references a multi-value field.\r\n         *\r\n         * Setting this option to `true` if appropriate will allow the corresponding [`CategoryFacet`]{@link CategoryFacet} or [`DynamicHierarchicalFacet`]{@link DynamicHierarchicalFacet} component (if present) to properly handle the filter format.\r\n         *\r\n         * See also the [`categoryFieldDelimitingCharacter`]{@link FacetValueSuggestions.options.categoryFieldDelimitingCharacter} option.\r\n         */\r\n        isCategoryField: ComponentOptions_1.ComponentOptions.buildBooleanOption({ defaultValue: false }),\r\n        /**\r\n         * The delimiting character used for the multi-value field referenced by the [`field`]{@link FacetValueSuggestions.options.field} option.\r\n         *\r\n         * @examples ;, #\r\n         */\r\n        categoryFieldDelimitingCharacter: ComponentOptions_1.ComponentOptions.buildStringOption({ defaultValue: '|', depend: 'isCategoryField' }),\r\n        /**\r\n         * An advanced query expression to add when requesting facet value suggestions.\r\n         *\r\n         * Set this option to ensure that the suggestions are properly scoped when using the component with a standalone search box. For instance, if a certain [tab]{@link Tab} is automatically selected in the search interface the standalone search box is redirecting its queries to, you should set this option to that tab's [`expression`]{@link Tab.options.expression}.\r\n         *\r\n         * @examples @objecttype==Message\r\n         */\r\n        expression: ComponentOptions_1.ComponentOptions.buildQueryExpressionOption()\r\n    };\r\n    return FacetValueSuggestions;\r\n}(Component_1.Component));\r\nexports.FacetValueSuggestions = FacetValueSuggestions;\r\nInitialization_1.Initialization.registerAutoCreateComponent(FacetValueSuggestions);\r\n\n\n/***/ }),\n\n/***/ 516:\n/***/ (function(module, exports) {\n\n// removed by extract-text-webpack-plugin\n\n/***/ }),\n\n/***/ 613:\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = y[op[0] & 2 ? \"return\" : op[0] ? \"throw\" : \"next\"]) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [0, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar FacetValueSuggestionsProvider = /** @class */ (function () {\r\n    function FacetValueSuggestionsProvider(queryController, options) {\r\n        this.queryController = queryController;\r\n        this.options = options;\r\n    }\r\n    FacetValueSuggestionsProvider.prototype.getSuggestions = function (valuesToSearch) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var fieldsToQuery;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.getFieldValuesToQuery(valuesToSearch)];\r\n                    case 1:\r\n                        fieldsToQuery = _a.sent();\r\n                        return [2 /*return*/, this.getAllSuggestionsRows(fieldsToQuery.responses, fieldsToQuery.reference)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FacetValueSuggestionsProvider.prototype.getAllSuggestionsRows = function (fieldResponses, fieldTotalReference) {\r\n        var _this = this;\r\n        return fieldResponses.reduce(function (allValues, fieldResponse) {\r\n            var suggestionRows = fieldResponse.values.map(function (indexFieldValue) {\r\n                return {\r\n                    numberOfResults: indexFieldValue.numberOfResults,\r\n                    keyword: fieldResponse.keyword,\r\n                    value: indexFieldValue.value,\r\n                    score: _this.computeScoreForSuggestionRow(indexFieldValue, fieldTotalReference),\r\n                    field: _this.options.field\r\n                };\r\n            });\r\n            return allValues.concat(suggestionRows);\r\n        }, []);\r\n    };\r\n    FacetValueSuggestionsProvider.prototype.getFieldValuesToQuery = function (valuesToSearch) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            var referenceValuesRequest, queryParts, suggestionValuesRequests, requests, values, reference, responses;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        referenceValuesRequest = this.buildReferenceFieldValueRequest();\r\n                        queryParts = this.getQueryToExecuteParts();\r\n                        if (this.options.expression) {\r\n                            queryParts.push(this.options.expression);\r\n                        }\r\n                        suggestionValuesRequests = valuesToSearch.map(function (keyword) {\r\n                            var queryToExecute = queryParts.concat([keyword.text]).join(' ');\r\n                            return _this.buildListFieldValueRequest(queryToExecute);\r\n                        });\r\n                        requests = suggestionValuesRequests.concat([referenceValuesRequest]);\r\n                        return [4 /*yield*/, this.queryController.getEndpoint().listFieldValuesBatch({\r\n                                batch: requests\r\n                            })];\r\n                    case 1:\r\n                        values = _a.sent();\r\n                        reference = this.computeReferenceFromBatch(values.pop());\r\n                        responses = values.map(function (value, i) {\r\n                            return {\r\n                                keyword: valuesToSearch[i],\r\n                                values: value\r\n                            };\r\n                        });\r\n                        return [2 /*return*/, {\r\n                                responses: responses,\r\n                                reference: reference\r\n                            }];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FacetValueSuggestionsProvider.prototype.computeScoreForSuggestionRow = function (fieldValue, reference) {\r\n        var totalNumberForFieldValue = reference.fieldsTotal[fieldValue.value] || reference.smallestTotal;\r\n        var distanceFromTotalForField = (totalNumberForFieldValue - fieldValue.numberOfResults) / totalNumberForFieldValue * 100;\r\n        return {\r\n            distanceFromTotalForField: distanceFromTotalForField\r\n        };\r\n    };\r\n    FacetValueSuggestionsProvider.prototype.computeReferenceFromBatch = function (batch) {\r\n        var fieldsTotal = {};\r\n        batch.forEach(function (value) { return (fieldsTotal[value.value] = value.numberOfResults); });\r\n        return {\r\n            fieldsTotal: fieldsTotal,\r\n            smallestTotal: batch[batch.length - 1].numberOfResults\r\n        };\r\n    };\r\n    FacetValueSuggestionsProvider.prototype.buildListFieldValueRequest = function (queryToExecute) {\r\n        return {\r\n            field: this.options.field,\r\n            ignoreAccents: true,\r\n            maximumNumberOfValues: 3,\r\n            queryOverride: queryToExecute\r\n        };\r\n    };\r\n    FacetValueSuggestionsProvider.prototype.buildReferenceFieldValueRequest = function () {\r\n        return {\r\n            field: this.options.field\r\n        };\r\n    };\r\n    FacetValueSuggestionsProvider.prototype.getQueryToExecuteParts = function () {\r\n        var lastQuery = this.queryController.getLastQuery();\r\n        var aqWithoutCurrentField = lastQuery && lastQuery.aq ? this.removeFieldExpressionFromExpression(this.options.field.toString(), lastQuery.aq) : '';\r\n        return [aqWithoutCurrentField, lastQuery.cq].filter(function (part) { return !!part; });\r\n    };\r\n    FacetValueSuggestionsProvider.prototype.removeFieldExpressionFromExpression = function (field, expression) {\r\n        var expressionWithParenthesis = '([^)]*)';\r\n        var expressionAsSingleValue = '[^ ]*';\r\n        return expression\r\n            .replace(new RegExp(field + \"==\" + expressionWithParenthesis, 'gi'), '')\r\n            .replace(new RegExp(field + \"==\" + expressionAsSingleValue, 'gi'), '');\r\n    };\r\n    return FacetValueSuggestionsProvider;\r\n}());\r\nexports.FacetValueSuggestionsProvider = FacetValueSuggestionsProvider;\r\n\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// FacetValueSuggestions.min__5f3280c404a1ee75a113.js","import 'styling/_FieldSuggestions';\r\nimport * as _ from 'underscore';\r\nimport { IPopulateOmniboxSuggestionsEventArgs, OmniboxEvents } from '../../events/OmniboxEvents';\r\nimport { exportGlobally } from '../../GlobalExports';\r\nimport { l } from '../../MiscModules';\r\nimport { QueryStateModel } from '../../ModelsModules';\r\nimport { $$ } from '../../utils/Dom';\r\nimport { DomUtils } from '../../UtilsModules';\r\nimport { analyticsActionCauseList, IAnalyticsNoMeta } from '../Analytics/AnalyticsActionListMeta';\r\nimport { Component } from '../Base/Component';\r\nimport { IComponentBindings } from '../Base/ComponentBindings';\r\nimport { ComponentOptions } from '../Base/ComponentOptions';\r\nimport { IFieldOption } from '../Base/IComponentOptions';\r\nimport { Initialization } from '../Base/Initialization';\r\nimport { IOmniboxSuggestion, Omnibox } from '../Omnibox/Omnibox';\r\nimport { FacetValueSuggestionsProvider, IFacetValueSuggestionRow, IFacetValueSuggestionsProvider } from './FacetValueSuggestionsProvider';\r\nimport { Suggestion } from '../../magicbox/SuggestionsManager';\r\n\r\nexport interface IFacetValueSuggestionsOptions {\r\n  numberOfSuggestions: number;\r\n  field?: IFieldOption;\r\n  isCategoryField?: boolean;\r\n  categoryFieldDelimitingCharacter?: string;\r\n  useQuerySuggestions?: boolean;\r\n  useValueFromSearchbox?: boolean;\r\n  displayEstimateNumberOfResults?: boolean;\r\n  expression?: string;\r\n  templateHelper?: (row: IFacetValueSuggestionRow, omnibox: Omnibox) => string;\r\n}\r\n\r\nexport interface IQuerySuggestionKeyword {\r\n  text: string;\r\n  html: string;\r\n}\r\n\r\n/**\r\n * This component provides [`Omnibox`]{@link Omnibox} query suggestions scoped to distinct categories based on the values of a\r\n * specific [`field`]{@link FacetValueSuggestions.options.field} whose [Facet](https://docs.coveo.com/en/1982/#facet) option is enabled.\r\n *\r\n * @externaldocs [Providing Facet Value Suggestions](https://docs.coveo.com/en/340/#providing-facet-value-suggestions)\r\n *\r\n * @availablesince [May 2018 Release (v2.4094.8)](https://docs.coveo.com/410/#may-2018-release-v240948)\r\n */\r\nexport class FacetValueSuggestions extends Component {\r\n  static ID = 'FacetValueSuggestions';\r\n\r\n  static doExport = () => {\r\n    exportGlobally({\r\n      FacetValueSuggestions: FacetValueSuggestions\r\n    });\r\n  };\r\n\r\n  /**\r\n   * @componentOptions\r\n   */\r\n  static options: IFacetValueSuggestionsOptions = {\r\n    /**\r\n     * The field on whose values the scoped query suggestions should be based.\r\n     *\r\n     * @examples @productcategory\r\n     */\r\n    field: ComponentOptions.buildFieldOption({ required: true }),\r\n\r\n    /**\r\n     * The maximum number of suggestions to render in the [`Omnibox`]{@link Omnibox}.\r\n     */\r\n    numberOfSuggestions: ComponentOptions.buildNumberOption({ defaultValue: 5, min: 1 }),\r\n\r\n    /**\r\n     * Whether to get scoped query suggestions from the current Coveo ML query suggestions.\r\n     *\r\n     * **Note:** If this options is set to `true` the [`enableQuerySuggestAddon`]{@link Omnibox.options.enableQuerySuggestAddon} option of the [`Omnibox`]{@link Omnibox.option.enableQuerySuggestAddon} component must be set to `true` as well.\r\n     */\r\n    useQuerySuggestions: ComponentOptions.buildBooleanOption({ defaultValue: true }),\r\n\r\n    /**\r\n     * Whether to get scoped query suggestions from the current user query entered in the search box.\r\n     *\r\n     * **Default:** `true` if [`useQuerySuggestions`]{@link FacetValueSuggestions.options.useQuerySuggestions} is `false`; `false` otherwise\r\n     */\r\n    useValueFromSearchbox: ComponentOptions.buildBooleanOption({\r\n      postProcessing: (value, options: IFacetValueSuggestionsOptions) => {\r\n        return value || !options.useQuerySuggestions;\r\n      }\r\n    }),\r\n\r\n    /**\r\n     * Whether to display an estimate of the number of results for each scoped query suggestions.\r\n     *\r\n     * **Notes:**\r\n     * - Setting this option to `true` has no effect when the [`templateHelper`]{@link FacetValueSuggestions.options.templateHelper} options is set.\r\n     * - When displaying scoped query suggestions for a standalone search box whose queries are redirected to a search interface enforcing other filters, the number of results will be inaccurate.\r\n     */\r\n    displayEstimateNumberOfResults: ComponentOptions.buildBooleanOption({ defaultValue: false }),\r\n\r\n    /**\r\n     * The template helper function to execute when rendering each scoped query suggestion.\r\n     *\r\n     * If specified, the function must have the following signature: (row: [IFacetValueSuggestionRow]{@link IFacetValueSuggestionRow}, omnibox: Omnibox) => string\r\n     *\r\n     * If not specified, a default function will be used.\r\n     *\r\n     * **Note:** You cannot set this option directly in the component markup as an HTML attribute. You must either set it:\r\n     * - In the [`init`]{@link init} call of your search interface (see [Passing Component Options in the init Call](https://docs.coveo.com/en/346/#passing-component-options-in-the-init-call)\r\n     * - Before the `init` call, using the [`options`](@link options) top-level function (see [Passing Component Options Before the init Call](https://docs.coveo.com/en/346/#passing-component-options-before-the-init-call)).\r\n     *\r\n     * **Example:**\r\n     *\r\n     * ```javascript\r\n     * Coveo.init(document.getElementById('search'), {\r\n     *   FacetValueSuggestions: {\r\n     *     templateHelper: (row, omnibox) => { return `Searching for <strong>${row.keyword}</strong> in category <em>${row.value}</em>`; }\r\n     *   }\r\n     * })\r\n     * ```\r\n     */\r\n    templateHelper: ComponentOptions.buildCustomOption<(row: IFacetValueSuggestionRow, omnibox: Omnibox) => string>(() => {\r\n      return null;\r\n    }),\r\n\r\n    /**\r\n     * Whether the [`field`]{@link FacetValueSuggestions.options.field} option references a multi-value field.\r\n     *\r\n     * Setting this option to `true` if appropriate will allow the corresponding [`CategoryFacet`]{@link CategoryFacet} or [`DynamicHierarchicalFacet`]{@link DynamicHierarchicalFacet} component (if present) to properly handle the filter format.\r\n     *\r\n     * See also the [`categoryFieldDelimitingCharacter`]{@link FacetValueSuggestions.options.categoryFieldDelimitingCharacter} option.\r\n     */\r\n    isCategoryField: ComponentOptions.buildBooleanOption({ defaultValue: false }),\r\n\r\n    /**\r\n     * The delimiting character used for the multi-value field referenced by the [`field`]{@link FacetValueSuggestions.options.field} option.\r\n     *\r\n     * @examples ;, #\r\n     */\r\n    categoryFieldDelimitingCharacter: ComponentOptions.buildStringOption({ defaultValue: '|', depend: 'isCategoryField' }),\r\n\r\n    /**\r\n     * An advanced query expression to add when requesting facet value suggestions.\r\n     *\r\n     * Set this option to ensure that the suggestions are properly scoped when using the component with a standalone search box. For instance, if a certain [tab]{@link Tab} is automatically selected in the search interface the standalone search box is redirecting its queries to, you should set this option to that tab's [`expression`]{@link Tab.options.expression}.\r\n     *\r\n     * @examples @objecttype==Message\r\n     */\r\n    expression: ComponentOptions.buildQueryExpressionOption()\r\n  };\r\n\r\n  public facetValueSuggestionsProvider: IFacetValueSuggestionsProvider;\r\n\r\n  private queryStateFieldFacetId;\r\n\r\n  static defaultTemplate(this: FacetValueSuggestions, row: IFacetValueSuggestionRow, omnibox: Omnibox): string {\r\n    const keyword = row.keyword.html;\r\n    const facetValue = DomUtils.highlight(row.value, 'coveo-omnibox-hightlight');\r\n    const details = this.options.displayEstimateNumberOfResults\r\n      ? DomUtils.highlight(\r\n          ` (${l('ResultCount', row.numberOfResults.toString(), row.numberOfResults)})`,\r\n          'coveo-omnibox-suggestion-results-count',\r\n          true\r\n        )\r\n      : '';\r\n    return `${l('KeywordInCategory', keyword, facetValue)}${details}`;\r\n  }\r\n\r\n  private static getQuerySuggestionKeywordFromText(text: string): IQuerySuggestionKeyword {\r\n    return {\r\n      text,\r\n      html: DomUtils.highlight(text, 'coveo-omnibox-hightlight')\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Creates a new `FacetValueSuggestions` component.\r\n   * @param element The HTMLElement on which to instantiate the component.\r\n   * @param options The options for the `FacetValueSuggestions` component.\r\n   * @param bindings The bindings that the component requires to function normally. If not set, these will be\r\n   * automatically resolved (with a slower execution time).\r\n   */\r\n  constructor(element: HTMLElement, public options: IFacetValueSuggestionsOptions, bindings?: IComponentBindings) {\r\n    super(element, FacetValueSuggestions.ID, bindings);\r\n\r\n    this.options = ComponentOptions.initComponentOptions(element, FacetValueSuggestions, options);\r\n\r\n    this.facetValueSuggestionsProvider = new FacetValueSuggestionsProvider(this.queryController, {\r\n      field: <string>this.options.field,\r\n      expression: this.options.expression\r\n    });\r\n    this.queryStateFieldFacetId = `f:${this.options.field}`;\r\n\r\n    if (!this.options.templateHelper) {\r\n      this.options.templateHelper = FacetValueSuggestions.defaultTemplate;\r\n    }\r\n\r\n    $$(this.root).on(OmniboxEvents.populateOmniboxSuggestions, (e: Event, args: IPopulateOmniboxSuggestionsEventArgs) => {\r\n      args.suggestions.push(this.getSuggestions(args.omnibox));\r\n    });\r\n  }\r\n\r\n  public async getSuggestions(omnibox: Omnibox): Promise<IOmniboxSuggestion[]> {\r\n    if (this.options.numberOfSuggestions == 0) {\r\n      return [];\r\n    }\r\n\r\n    const text = omnibox.getText();\r\n\r\n    const suggestions: IOmniboxSuggestion[] = await this.getFacetValueSuggestions(text, omnibox);\r\n\r\n    return suggestions || [];\r\n  }\r\n\r\n  private async getQuerySuggestionsKeywords(omnibox: Omnibox): Promise<IQuerySuggestionKeyword[]> {\r\n    if (this.options.useQuerySuggestions && omnibox.suggestionAddon) {\r\n      const suggestions = await omnibox.suggestionAddon.getSuggestion();\r\n      return suggestions.map(({ text, html }) => <IQuerySuggestionKeyword>{ text: text || '', html });\r\n    } else {\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private async getFacetValueSuggestions(text: string, omnibox: Omnibox): Promise<IOmniboxSuggestion[]> {\r\n    const wordsToQuery = this.options.useValueFromSearchbox ? [FacetValueSuggestions.getQuerySuggestionKeywordFromText(text)] : [];\r\n\r\n    const suggestionsKeywords: IQuerySuggestionKeyword[] = await this.getQuerySuggestionsKeywords(omnibox);\r\n    const allKeywordsToQuery = _.unique(\r\n      wordsToQuery.concat(suggestionsKeywords).filter(keyword => keyword.text != ''),\r\n      keyword => keyword.text\r\n    );\r\n\r\n    if (allKeywordsToQuery.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    return this.getSuggestionsForWords(allKeywordsToQuery, omnibox);\r\n  }\r\n\r\n  private async getSuggestionsForWords(keywordToQuery: IQuerySuggestionKeyword[], omnibox: Omnibox): Promise<IOmniboxSuggestion[]> {\r\n    try {\r\n      const suggestions = await this.facetValueSuggestionsProvider.getSuggestions(keywordToQuery);\r\n\r\n      this.logger.debug('FacetValue Suggestions Results', suggestions);\r\n\r\n      const currentSelectedValues: string[] = this.queryStateModel.get(this.queryStateFieldFacetId) || [];\r\n      const filteredSuggestions = suggestions.filter(suggestion =>\r\n        this.isSuggestionRowAlreadyCheckedInFacet(suggestion, currentSelectedValues)\r\n      );\r\n      return this.rankSuggestionRows(filteredSuggestions).map(result => this.mapFacetValueSuggestion(result, omnibox));\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private isSuggestionRowAlreadyCheckedInFacet(suggestion: IFacetValueSuggestionRow, currentlySelectedValues: string[]): boolean {\r\n    return !currentlySelectedValues.some(value => value == suggestion.value);\r\n  }\r\n\r\n  private rankSuggestionRows(suggestions: IFacetValueSuggestionRow[]): IFacetValueSuggestionRow[] {\r\n    const rankedResults = [...suggestions.sort((a, b) => b.score.distanceFromTotalForField - a.score.distanceFromTotalForField)];\r\n    const firstSlice = Math.ceil(this.options.numberOfSuggestions / 2);\r\n    const lastSlice = -Math.floor(this.options.numberOfSuggestions / 2);\r\n\r\n    const firstResultsToReturn = rankedResults.splice(0, firstSlice);\r\n\r\n    if (lastSlice != 0) {\r\n      const lastResultsToReturn = rankedResults.slice(lastSlice);\r\n      return [...firstResultsToReturn, ...lastResultsToReturn];\r\n    }\r\n\r\n    return firstResultsToReturn;\r\n  }\r\n\r\n  private mapFacetValueSuggestion(resultToShow: IFacetValueSuggestionRow, omnibox: Omnibox) {\r\n    const suggestion: IOmniboxSuggestion = {\r\n      html: this.buildDisplayNameForRow(resultToShow, omnibox),\r\n      text: resultToShow.keyword.text\r\n    };\r\n\r\n    const fieldValues = this.options.isCategoryField\r\n      ? resultToShow.value.split(this.options.categoryFieldDelimitingCharacter)\r\n      : [resultToShow.value];\r\n\r\n    suggestion.advancedQuery = fieldValues.map(value => `${this.options.field}==\"${value}\"`).join(' AND ');\r\n\r\n    suggestion.onSelect = () => this.onSuggestionSelected(suggestion, fieldValues, omnibox);\r\n\r\n    return suggestion;\r\n  }\r\n\r\n  private buildDisplayNameForRow(row: IFacetValueSuggestionRow, omnibox: Omnibox): string {\r\n    try {\r\n      return this.options.templateHelper.call(this, row, omnibox);\r\n    } catch (ex) {\r\n      this.logger.error('Could not apply template from options for the given row. Will use default template.', ex, row, omnibox);\r\n      return FacetValueSuggestions.defaultTemplate.call(this, row, omnibox);\r\n    }\r\n  }\r\n\r\n  private onSuggestionSelected(suggestion: Suggestion, fieldValues: string[], omnibox: Omnibox): void {\r\n    omnibox.setText(suggestion.text);\r\n    // Copy the state here, else it will directly modify queryStateModel.defaultAttributes.fv.\r\n    const fvState: { [key: string]: string[] } = { ...this.queryStateModel.get(QueryStateModel.attributesEnum.fv) };\r\n    const existingValues: string[] = fvState[this.options.field.toString()] || [];\r\n\r\n    fvState[this.options.field.toString()] = existingValues.concat(fieldValues);\r\n\r\n    this.queryStateModel.set(QueryStateModel.attributesEnum.fv, fvState);\r\n    omnibox.magicBox.blur();\r\n    this.usageAnalytics.logSearchEvent<IAnalyticsNoMeta>(analyticsActionCauseList.omniboxField, {});\r\n    this.queryController.executeQuery();\r\n  }\r\n}\r\n\r\nInitialization.registerAutoCreateComponent(FacetValueSuggestions);\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/ui/FacetValueSuggestions/FacetValueSuggestions.ts","import { QueryController } from '../../Core';\r\nimport { IIndexFieldValue } from '../../rest/FieldValue';\r\nimport { IListFieldValuesRequest } from '../../rest/ListFieldValuesRequest';\r\nimport { IFieldOption } from '../Base/IComponentOptions';\r\nimport { IQuerySuggestionKeyword } from './FacetValueSuggestions';\r\n\r\n/**\r\n * Used to define a row returned by an [`IFacetValueSuggestionsProvider`]{@link IFacetValueSuggestionsProvider}.\r\n */\r\nexport interface IFacetValueSuggestionRow {\r\n  /**\r\n   * The score computed by the suggestions provider.\r\n   *\r\n   * A higher score means the results is more relevant.\r\n   */\r\n  score: IFacetValueSuggestionScore;\r\n\r\n  /**\r\n   * The field value returned by the suggestion that should be used to filter the results.\r\n   */\r\n  value: string;\r\n  /**\r\n   * The number of results matching the value for the given keyword.\r\n   */\r\n  numberOfResults: number;\r\n  /**\r\n   * The keyword that was used in the query to retrieve results.\r\n   */\r\n  keyword: IQuerySuggestionKeyword;\r\n  /**\r\n   * The field that was used for the suggestions.\r\n   */\r\n  field: IFieldOption;\r\n}\r\n\r\nexport interface IFacetValueSuggestionScore {\r\n  distanceFromTotalForField: number;\r\n}\r\n\r\ninterface IFacetValueSuggestionsResponse {\r\n  responses: IFacetValueBatchResponse[];\r\n  reference: IFacetValueReference;\r\n}\r\n\r\ninterface IFacetValueBatchResponse {\r\n  values: IIndexFieldValue[];\r\n  keyword: IQuerySuggestionKeyword;\r\n}\r\n\r\ntype IFacetValueReference = {\r\n  fieldsTotal: { [value: string]: number };\r\n  smallestTotal: number;\r\n};\r\n\r\n/**\r\n * Defines options for the [`FacetValueSuggestions`]{@link FacetValueSuggestions} component.\r\n */\r\nexport interface IFacetValueSuggestionsProviderOptions {\r\n  field: string;\r\n  expression?: string;\r\n}\r\n\r\n/**\r\n * Provides suggestions for the [`FacetValueSuggestions`]{@link FacetValueSuggestions} component.\r\n */\r\nexport interface IFacetValueSuggestionsProvider {\r\n  getSuggestions(valuesToSearch: IQuerySuggestionKeyword[]): Promise<IFacetValueSuggestionRow[]>;\r\n}\r\n\r\nexport class FacetValueSuggestionsProvider implements IFacetValueSuggestionsProvider {\r\n  constructor(private queryController: QueryController, private options: IFacetValueSuggestionsProviderOptions) {}\r\n\r\n  public async getSuggestions(valuesToSearch: IQuerySuggestionKeyword[]): Promise<IFacetValueSuggestionRow[]> {\r\n    const fieldsToQuery = await this.getFieldValuesToQuery(valuesToSearch);\r\n    return this.getAllSuggestionsRows(fieldsToQuery.responses, fieldsToQuery.reference);\r\n  }\r\n\r\n  private getAllSuggestionsRows(\r\n    fieldResponses: IFacetValueBatchResponse[],\r\n    fieldTotalReference: IFacetValueReference\r\n  ): IFacetValueSuggestionRow[] {\r\n    return fieldResponses.reduce((allValues, fieldResponse) => {\r\n      const suggestionRows = fieldResponse.values.map(indexFieldValue => {\r\n        return <IFacetValueSuggestionRow>{\r\n          numberOfResults: indexFieldValue.numberOfResults,\r\n          keyword: fieldResponse.keyword,\r\n          value: indexFieldValue.value,\r\n          score: this.computeScoreForSuggestionRow(indexFieldValue, fieldTotalReference),\r\n          field: this.options.field\r\n        };\r\n      });\r\n      return allValues.concat(suggestionRows);\r\n    }, []);\r\n  }\r\n\r\n  private async getFieldValuesToQuery(valuesToSearch: IQuerySuggestionKeyword[]): Promise<IFacetValueSuggestionsResponse> {\r\n    // The reference request will be used to get the maximum number of values for a given facet value.\r\n    const referenceValuesRequest = this.buildReferenceFieldValueRequest();\r\n    const queryParts = this.getQueryToExecuteParts();\r\n\r\n    if (this.options.expression) {\r\n      queryParts.push(this.options.expression);\r\n    }\r\n\r\n    const suggestionValuesRequests = valuesToSearch.map(keyword => {\r\n      const queryToExecute = [...queryParts, keyword.text].join(' ');\r\n      return this.buildListFieldValueRequest(queryToExecute);\r\n    });\r\n\r\n    const requests = [...suggestionValuesRequests, referenceValuesRequest];\r\n    const values = await this.queryController.getEndpoint().listFieldValuesBatch({\r\n      batch: requests\r\n    });\r\n\r\n    const reference = this.computeReferenceFromBatch(values.pop());\r\n    const responses: IFacetValueBatchResponse[] = values.map((value, i) => {\r\n      return <IFacetValueBatchResponse>{\r\n        keyword: valuesToSearch[i],\r\n        values: value\r\n      };\r\n    });\r\n\r\n    return <IFacetValueSuggestionsResponse>{\r\n      responses,\r\n      reference\r\n    };\r\n  }\r\n\r\n  private computeScoreForSuggestionRow(fieldValue: IIndexFieldValue, reference: IFacetValueReference): IFacetValueSuggestionScore {\r\n    const totalNumberForFieldValue = reference.fieldsTotal[fieldValue.value] || reference.smallestTotal;\r\n    const distanceFromTotalForField: number = (totalNumberForFieldValue - fieldValue.numberOfResults) / totalNumberForFieldValue * 100;\r\n    return {\r\n      distanceFromTotalForField\r\n    };\r\n  }\r\n\r\n  private computeReferenceFromBatch(batch: IIndexFieldValue[]): IFacetValueReference {\r\n    const fieldsTotal = {};\r\n    batch.forEach(value => (fieldsTotal[value.value] = value.numberOfResults));\r\n    return {\r\n      fieldsTotal: fieldsTotal,\r\n      smallestTotal: batch[batch.length - 1].numberOfResults\r\n    };\r\n  }\r\n\r\n  private buildListFieldValueRequest(queryToExecute: string): IListFieldValuesRequest {\r\n    return {\r\n      field: <string>this.options.field,\r\n      ignoreAccents: true,\r\n      maximumNumberOfValues: 3,\r\n      queryOverride: queryToExecute\r\n    };\r\n  }\r\n\r\n  private buildReferenceFieldValueRequest(): IListFieldValuesRequest {\r\n    return {\r\n      field: <string>this.options.field\r\n    };\r\n  }\r\n\r\n  private getQueryToExecuteParts(): string[] {\r\n    const lastQuery = this.queryController.getLastQuery();\r\n    const aqWithoutCurrentField =\r\n      lastQuery && lastQuery.aq ? this.removeFieldExpressionFromExpression(this.options.field.toString(), lastQuery.aq) : '';\r\n\r\n    return [aqWithoutCurrentField, lastQuery.cq].filter(part => !!part);\r\n  }\r\n\r\n  private removeFieldExpressionFromExpression(field: string, expression: string): string {\r\n    const expressionWithParenthesis = '([^)]*)';\r\n    const expressionAsSingleValue = '[^ ]*';\r\n    return expression\r\n      .replace(new RegExp(`${field}==${expressionWithParenthesis}`, 'gi'), '')\r\n      .replace(new RegExp(`${field}==${expressionAsSingleValue}`, 'gi'), '');\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/ui/FacetValueSuggestions/FacetValueSuggestionsProvider.ts"],"sourceRoot":""}